{% extends "base.html" %}
{% block title %}Profile{% endblock %}
{% block content %}
<div class="container">
    <h1><i class="ph ph-user-circle"></i> User Profile</h1>
    <div class="profile-card" style="margin-bottom: 16px;">
        <p><strong>Role:</strong> {{ user.role.role_name }}</p>
        {% if user.department %}<p><strong>Department:</strong> {{ user.department.dept_name }}</p>{% endif %}
        {% if user.role and (user.role.role_name|lower) == 'student' %}
        <p><strong>Reg No:</strong> {{ user.username or '—' }}</p>
        {% endif %}
            {% if is_guest_user %}
            <p><strong>Guest ID:</strong> {{ user.username or '—' }}</p>
            {% endif %}
        <p><strong>Member Since:</strong> {{ user.created_at.strftime('%B %d, %Y') }}</p>
        
    </div>

    <form method="POST" class="form-card">
        {% set role_lower = user.role.role_name|lower if user.role else '' %}
        {# Determine guest status from role only (legacy `is_guest` removed) #}
        {% set is_guest_user = (role_lower == 'guest') %}
        {# allow guest users to edit name even if their role is 'student' #}
        {% set is_student = (role_lower == 'student') and (not is_guest_user) %}
        <div class="form-row">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" name="full_name" class="form-control" value="{{ user.full_name }}" {% if is_student %}disabled{% else %}required{% endif %}>
                {% if is_guest_user %}
                <p class="text-muted" style="margin-top:6px;">Note: This name may be auto-generated for guest accounts. Please edit it to your real name so certificates are generated correctly.</p>
                {% endif %}
            </div>
            {% if not role_lower in ['admin', 'hod', 'principal', 'organizer', 'event organizer'] %}
            <div class="form-group">
                <label>Username</label>
                {% if is_guest_user or is_student %}
                    {# Guests and students cannot edit username; show plaintext and keep value in hidden input #}
                    <div class="form-control-plaintext" style="background:transparent;border:none;padding:8px 0;color:#333;">{{ user.username or '—' }}</div>
                    <input type="hidden" name="username" value="{{ user.username or '' }}">
                {% else %}
                    <input type="text" name="username" class="form-control" value="{{ user.username or '' }}">
                {% endif %}
            </div>
            {% endif %}
            <div class="form-group">
                <label>Email</label>
                {% if is_guest_user %}
                    <div class="form-control-plaintext" style="background:transparent;border:none;padding:8px 0;color:#333;">{{ user.email or '—' }}</div>
                    <input type="hidden" name="email" value="{{ user.email or '' }}">
                    <p class="text-muted" style="margin-top:6px;">Guest email is managed by the administrator and cannot be changed here.</p>
                {% else %}
                    <input type="email" name="email" class="form-control" value="{{ user.email or '' }}" required>
                {% endif %}
            </div>
        </div>
        {% if is_student %}
        <p class="text-muted" style="margin-top: 8px;">Name and username updates are disabled for students. Please contact admin for corrections.</p>
        {% endif %}
        <button type="submit" class="btn btn-primary">Save Changes</button>
        {% if not is_guest_user %}
        <a href="{{ url_for('auth.change_password') }}" class="btn btn-secondary">Change Password</a>
        {% endif %}
    </form>
</div>
{% endblock %}
