{% extends "base.html" %}

{% block title %}Student Dashboard{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="ph ph-books"></i> Student Dashboard</h1>
        <p>Welcome, {{ session.full_name }}!</p>
    </div>
    {% if (session.role_name and session.role_name|lower == 'guest') or session.get('is_guest') %}
    <div style="background: linear-gradient(135deg,#fff7ed,#ffedd5); border-left: 4px solid #f97316; padding: 0.9rem 1rem; border-radius: 8px; margin-bottom:1rem;">
        <strong>Note for guests:</strong>
        <span style="margin-left:0.5rem;">This is a temporary guest account (valid for 30 days). Make sure to download any certificates or important data before it expires.</span>
        <p style="margin-top:6px; margin-bottom:0;">The name on guest accounts may be auto-generated. Please <a href="{{ url_for('common.profile') }}">edit your Full Name</a> to your real name so certificates are generated correctly.</p>
    </div>
    {% endif %}
    
    <!-- Notifications Section -->
    {% if notifications %}
        <div class="notifications-section" style="margin-bottom: 1.5rem; position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; width: 350px; max-width: 90vw;">
            {% for notif in notifications[:3] %}
            <a href="{{ notif.link }}" class="notification-card notification-{{ notif.type }} student-toast" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; margin-bottom: 0.5rem; border-radius: 10px; text-decoration: none; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 12px rgba(0,0,0,0.10); animation: fadeout 5s linear forwards; {% if notif.type == 'certificate' %}background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b;{% elif notif.type == 'feedback' %}background: linear-gradient(135deg, #e0e7ff, #c7d2fe); border-left: 4px solid #6366f1;{% elif notif.type == 'invitation' %}background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-left: 4px solid #16a34a;{% elif notif.type == 'reminder' %}background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 4px solid #2563eb;{% else %}background: var(--bg-light); border-left: 4px solid var(--primary-color);{% endif %}">
                <i class="ph-fill {{ notif.icon }}" style="font-size: 1.5rem; flex-shrink: 0; {% if notif.type == 'certificate' %}color: #d97706;{% elif notif.type == 'feedback' %}color: #6366f1;{% elif notif.type == 'invitation' %}color: #16a34a;{% elif notif.type == 'reminder' %}color: #2563eb;{% else %}color: var(--primary-color);{% endif %}"></i>
                <div style="flex: 1; min-width: 0;">
                    <p style="margin: 0; font-weight: 500; color: var(--text-dark);">{{ notif.message }}</p>
                </div>
                <i class="ph ph-caret-right" style="font-size: 1.2rem; color: var(--text-medium); flex-shrink: 0;"></i>
            </a>
            {% endfor %}
        </div>
    {% endif %}

    <style>
    @keyframes fadeout {
        0% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; }
        100% { opacity: 0; transform: translateY(-20px); pointer-events: none; }
    }
    </style>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var key = 'dashboard_notifications_shown';
        var toasts = document.querySelectorAll('.student-toast');
        if (!toasts || toasts.length === 0) return;

        if (!sessionStorage.getItem(key)) {
            // First time this session: show toasts, then hide after 5s and mark shown
            setTimeout(function() {
                toasts.forEach(function(el) { el.style.display = 'none'; });
                try { sessionStorage.setItem(key, '1'); } catch (e) {}
            }, 5000);
        } else {
            // Already shown in this session: hide immediately
            toasts.forEach(function(el) { el.style.display = 'none'; });
        }
    });
    </script>

    <div class="dashboard-stats">
        <div class="stat-card">
            <h3>{{ upcoming_events|length }}</h3>
            <p>Upcoming Events</p>
        </div>
        <div class="stat-card">
            <h3>{{ registered_event_ids|length }}</h3>
            <p>My Registrations</p>
        </div>
        <div class="stat-card">
            <h3>{{ attended_event_ids|length }}</h3>
            <p>Events Attended</p>
        </div>
    </div>
    
    {% if pending_invitations_count and pending_invitations_count > 0 %}
    <div style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; padding: 1rem 1.25rem; border-radius: 10px; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <i class="ph ph-users-three" style="font-size: 1.5rem;"></i>
            <div>
                <strong>You have {{ pending_invitations_count }} team invitation{{ 's' if pending_invitations_count > 1 else '' }}!</strong>
                <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Someone wants you to join their team</p>
            </div>
        </div>
        <a href="{{ url_for('student.team_invitations') }}" class="btn" style="background: white; color: var(--primary-color); font-weight: 600;">
            <i class="ph ph-envelope"></i> View Invitations
        </a>
    </div>
    {% endif %}

    <div class="section">
        <h2><i class="ph ph-confetti"></i> Upcoming Events</h2>
        {% if upcoming_events %}
            <div class="events-grid">
                {% for event in upcoming_events %}
                <div class="event-card">
                    {% if event.poster_url %}
                        <img src="{{ url_for('static', filename=event.poster_url) }}" alt="{{ event.title }} poster" class="event-poster">
                    {% endif %}
                    <div class="event-header">
                        <h3>{{ event.title }}</h3>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <span class="badge badge-success">{{ event.status }}</span>
                            {% if event.is_team_event %}
                            <span class="badge" style="background: #7c3aed; color: white;"><i class="ph ph-users-three"></i> Team</span>
                            {% endif %}
                            {% if event.duty_leave_provided %}
                            <span class="badge" style="background: #10b981; color: white;"><i class="ph ph-briefcase"></i> Duty Leave</span>
                            {% endif %}
                        </div>
                    </div>
                    <p class="event-description">
                        {% set short = event.description[:150] %}
                        <span class="desc-short">{{ short }}{% if event.description|length > 150 %}...{% endif %}</span>
                        <span class="desc-full" style="display:none;">{{ event.description }}</span>
                        {% if event.description|length > 150 %}
                            <a href="#" class="read-more" role="button">Read more</a>
                        {% endif %}
                    </p>
                    <div class="event-details">
                        <p><strong><i class="ph ph-calendar"></i> Date:</strong> {{ event.date.strftime('%B %d, %Y') }}</p>
                        <p><strong><i class="ph ph-clock"></i> Time:</strong> {{ event.start_time.strftime('%H:%M') }} - {{ event.end_time.strftime('%H:%M') }}</p>
                        <p><strong><i class="ph ph-broadcast"></i> Mode:</strong>
                            {% if (event.mode or '')|lower == 'online' %}
                                Online
                            {% else %}
                                Offline
                            {% endif %}
                        </p>
                        <p><strong><i class="ph ph-map-pin"></i> Venue:</strong> {{ event.venue.venue_name if event.venue else '—' }}</p>
                        <p><strong><i class="ph ph-buildings"></i> Department:</strong> {{ event.department.dept_name }}</p>
                        {% if event.is_team_event %}
                        <p><strong><i class="ph ph-users"></i> Team Size:</strong> {{ event.min_team_size }}-{{ event.max_team_size }} members</p>
                        {% endif %}
                    </div>
                    
                    {% if event.event_id in registered_event_ids %}
                        {% if event.event_id in (attended_event_ids or []) %}
                            <button class="btn btn-success" disabled><i class="ph ph-check-circle"></i> Attended</button>
                        {% else %}
                            <button class="btn btn-secondary" disabled><i class="ph ph-check"></i> Already Registered</button>
                        {% endif %}
                        {% if (event.mode or '')|lower == 'online' and event.meeting_url %}
                            <p style="margin-top:8px;"><a href="{{ event.meeting_url }}" class="btn btn-sm btn-outline-primary" target="_blank"><i class="ph ph-video-camera"></i> Join Meeting</a></p>
                        {% endif %}
                    {% else %}
                        <form method="POST" action="{{ url_for('student.register_event', event_id=event.event_id) }}" style="display: inline;">
                            {% if event.is_team_event %}
                            <button type="submit" class="btn btn-primary"><i class="ph ph-users-three"></i> Create/Join Team</button>
                            {% else %}
                            <button type="submit" class="btn btn-primary"><i class="ph ph-user-plus"></i> Register Now</button>
                            {% endif %}
                        </form>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <p>No upcoming events at the moment.</p>
            </div>
        {% endif %}
    </div>

    <div class="section">
        <h2><i class="ph ph-scroll"></i> Recently Attended Events</h2>
        {% if past_events %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Department</th>
                            <th>Organizer</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in past_events[:5] %}
                        <tr>
                            <td>{{ event.title }}</td>
                            <td>{{ event.date.strftime('%B %d, %Y') }}</td>
                            <td>{{ event.department.dept_name }}</td>
                            <td>{{ event.organizer.full_name if event.organizer else '—' }}</td>
                            <td>
                                <a href="{{ url_for('student.submit_feedback', event_id=event.event_id) }}" class="btn btn-sm">
                                    Submit Feedback
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <p>You haven't attended any events yet.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
